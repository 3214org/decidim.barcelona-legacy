app:
  build: .
  command: "bundle exec rails s -b 0.0.0.0"
  environment:
    - DATABASE_HOST=db
    - DATABASE_USERNAME=postgres
    - DATABASE_PASSWORD=
    - DATABASE_NAME=postgres
    - REDIS_URL=redis://redis:6379
    - GEM_HOME=/bundle
    - GOOGLE_MAPS_API_KEY=${GOOGLE_MAPS_API_KEY}
    - FACEBOOK_KEY=${FACEBOOK_KEY}
    - FACEBOOK_SECRET=${FACEBOOK_SECRET}
    - TWITTER_KEY=${TWITTER_KEY}
    - TWITTER_SECRET=${TWITTER_SECRET}
    - GOOGLE_OAUTH2_KEY=${GOOGLE_OAUTH2_KEY}
    - GOOGLE_OAUTH2_SECRET=${GOOGLE_OAUTH2_SECRET}
  volumes:
    - .:/decidim.barcelona
  volumes_from:
    - bundle
  links:
    - db
    - redis
  ports:
    - "3000:3000"

sidekiq:
  image: decidimbarcelona_app
  command: bundle exec sidekiq
  environment:
    - DATABASE_HOST=db
    - DATABASE_USERNAME=postgres
    - DATABASE_PASSWORD=
    - DATABASE_NAME=postgres
    - REDIS_URL=redis://redis:6379
    - GEM_HOME=/bundle
  volumes:
    - .:/decidim.barcelona
  volumes_from:
    - bundle
  links:
    - db
    - redis

bundle:
  image: decidimbarcelona_app
  command: echo 'Nothing to do here'
  volumes:
    - .bundle:/bundle

db:
  image: postgres
  volumes_from:
    - db_data

db_data:
  image: decidimbarcelona_app
  command: echo 'Nothing to do here'
  command: echo 'Nothing to do here'
  volumes:
    - .db_data:/var/lib/postgresql/data

redis:
  image: "redis"
  volumes:
    - /var/lib/redis:/data
